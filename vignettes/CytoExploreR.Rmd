---
title: "Getting Started"
author: Dillon Hammill
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    includes:
      in_header: logo.html
vignette: >
  %\VignetteIndexEntry{CytoExploreR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

<div style="line-height: 1.8em;"> The full capabilities of **CytoExploreR** will be documented in series of vignettes which address specific aspects of the data analysis pipeline. Before we dive into the details, let's walk through the basic steps to analyse some *in vitro* T cell activation data using **CytoExploreR**. 

This **Activation** dataset and associated **Compensation** controls have been shipped with **CytoExploreRData** for demonstration purposes. This *in vitro* assay involves stimulating dendritic cells (DCs) with different immune stimulators (referred to as Stim-A, Stim-B, Stim-C and Stim-D) under increasing concentrations of the surrogate antigen ovalbumin (0 nM, 5 nM, 50 nM or 500 nM OVA). These activated DCs are then co-cultured with antigen-specific OT-I (CD8+) and OT-II (CD4+) T cells. The ability of each of the immune stimulators to promote T cell activation was then assessed by measuring the expression of T cell activation markers (CD44 and CD69) by flow cytometry.

Although **CytoExploreR** has full support for automated gating through **openCyto**, for simplicity in this vignette we will describe a manual gating analysis pipeline to analyse this dataset. </div>

<br>

# 1. Set Up New R Project

<div style="line-height: 1.8em;"> Before we begin, we will need to create a new R project by following these steps:

+ Select File -> New Project
+ Select New Directory -> New Project 
+ Set Directory Name to "CytoExploreR-Demo"
+ Indicate where the project should be created and select Create Project

</div>

<br>

# 2. Load Required Packages

<div style="line-height: 1.8em;"> **CytoExploreR** is closely integrated with the RGLab's suite of cytometry packages, including **flowCore**, **flowWorkspace** and **openCyto**. This means that these packages will be automatically loaded when **CytoExploreR** is loaded and any functions from these packages are completely compatible with **CytoExploreR**. To demonstrate the features of **CytoExploreR** we will also need to load **CytoExploreRData** which contains the **Compensation** and **Activation** datasets.  </div>

```{r, eval = FALSE}
# Load required packages
library(CytoExploreR)
library(CytoExploreRData)
```

<br>

# 3. Save FCS Files

<div style="line-height: 1.8em;"> Users should create a new folder in the current working directory and add their FCS files into this folder. It is recommended that you store your compensation controls and samples in separate folders as these files will be analysed separately. The following snippet outlines the steps required to download FCS files for the **Compensation** and **Activation** datasets and save them to appropriately named folders in your current working directory. </div>

```{r, eval = FALSE}
# Compensation FCS Files
cyto_save(Compensation, 
          save_as = "Compensation-Samples")

# Activation FCS Files
cyto_save(Activation,
          save_as = "Activation-Samples")
```

<br>

# 4. Compensation of Fluorescent Spillover

<div style="line-height: 1.8em;"> Flow cytometry users will need to compensate their data for fluorescent spillover prior to downstream analyses. The basic steps required to compute and refine the spillover matrix are outlined below. Refer to the Compensation vignette for a more details. </div>

## 4.1 Prepare compensation controls

<div style="line-height: 1.8em;"> The compensation controls can be loaded into a GatingSet by passing the name of the folder where the FCS files are saved to `cyto_setup`. At this stage it is also a good idea to setup a new gatingTemplate to record any downstream gating operations. Once the compensation controls have been loaded into a GatingSet, we need to transform the fluorescent channels using `cyto_transform`. The transformed data can then be gated using `cyto_gate_draw` to remove debris and doublets to ensure accurate computation of spillover values. </div>

```{r, eval = FALSE}
# Setup compensation controls
gs <- cyto_setup("Compensation-Samples",
                 gatingTemplate = "Compensation-gatingTemplate.csv")

# Transform fluorescent channels - default logicle transformations
gs <- cyto_transform(gs)

# Gate Cells
cyto_gate_draw(gs,
               parent = "root",
               alias = "Cells",
               channels = c("FSC-A", "SSC-A"))

# Gate Single Cells
cyto_gate_draw(gs,
               parent = "Cells",
               alias = "Single Cells",
               channels = c("FSC-A", "SSC-A"))
```

```{r, echo=FALSE, fig.align="center", out.width = '98%'}
knitr::include_graphics('CytoExploreR/CytoExploreR-1.png')
```

<br>

## 4.2 Compute Spillover Matrix

<div style="line-height: 1.8em;"> The spillover matrix can be automatically calculated using `cyto_spillover_compute`. Users are asked to assign a channel to compensation control and then gate the positive signal for each control in the indicated channel. **CytoExploreR** supports the use of either a universal unstained control or requires that each single colour control contain its own internal unstained reference population. The spillover matrix will be calculated using the method described by Bagwell & Adams 1993. </div>

```{r, eval = FALSE}
# Compute spillover matrix
spill <- cyto_spillover_compute(gs,
                                parent = "Single Cells",
                                spillover = "Spillover-Matrix.csv")
```

```{r, echo=FALSE, fig.align="center", out.width = '98%'}
# knitr::include_graphics('Compensation/Compensation-Auto-3.png')
```

## 4.3 Edit Spillover Matrix

<div style="line-height: 1.8em;"> The computed spillover matrix can be interactively edited in realtime using `cyto_spillover_edit`. Users should refer to the **Plots** to identify any lingering compensation issues and return to the **Editor** tab to refine the spillover matrix. By definition, the data is correctly compensated when the MedFI of the stained control is equal to that of the reference unstained control in all secondary detectors. The updated spillover matrix will be saved to a CSV file for downstream use. </div>

```{r, eval = FALSE}
# Edit spillover matrix
spill <- cyto_spillover_edit(gs,
                             parent = "Single Cells",
                             spillover = "Spillover-Matrix.csv")
```

```{r, echo=FALSE, fig.align="center", out.width = '98%'}
# knitr::include_graphics('Compensation/Compensation-Auto-3.png')
```

<br>

## 4.4 Visualise Compensation

<div style="line-height: 1.8em;"> After editing the spillover matrix manually, it is a good idea to check that all compensation issues have been addressed. The easiest way to do this without having to launch the spillover matrix editor is through `cyto_plot_compensation`. `cyto_plot_compensation` will plot uncompensated and compensated data in all fluorescent channels to check the compensation. The unstained control will automatically be overlaid onto the plots as areference if supplied. </div>

```{r, eval = FALSE}
# Visualise uncompensated data
cyto_plot_compensation(gs,
                       parent = "Single Cells")

# Visualise compensated data
cyto_plot_compensation(gs,
                       parent = "Single Cells",
                       spillover = "Spillover-Matrix.csv",
                       compensate = TRUE)
```

```{r, echo=FALSE, fig.align="center", out.width = '98%'}
# knitr::include_graphics('Compensation/Compensation-Auto-3.png')
```

# 5. Analyse Samples

## 5.1 










